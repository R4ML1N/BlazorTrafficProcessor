name: Java CI with Gradle

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

# Explicit permissions for releases/tags
permissions:
  contents: write
  packages: read
  issues: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'oracle'
          java-version: '17'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # Build the same fat JAR that Docker builds (shadowJar to ./releases/)
      - name: Build fat JAR with Shadow
        run: ./gradlew clean shadowJar

      # Upload the fat JAR as an artifact
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          path: ./releases/*.jar
          name: Downloadable Extension File

      # Decide prefix depending on the branch
      - name: Determine prefix based on branch
        id: prefix
        run: |
          if [[ "${GITHUB_REF}" == "refs/heads/main" ]]; then
            PREFIX="MainBranch_"
          else
            PREFIX="NotMainBranch_"
          fi
          echo "PREFIX=$PREFIX" >> $GITHUB_ENV
          echo "prefix=$PREFIX" >> $GITHUB_OUTPUT

      # Extract version from build.gradle
      - name: Extract new version from Gradle
        id: version
        run: |
          VERSION=$(grep "^version" build.gradle | awk -F"'" '{print $2}')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # Compute final release tag
      - name: Compute release tag
        id: tag
        run: |
          RELEASE_TAG="${PREFIX}${VERSION}"
          echo "RELEASE_TAG=$RELEASE_TAG" >> $GITHUB_ENV
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT

      # Find the latest previous release with the same prefix
      - name: Find previous release with same prefix
        id: previous
        run: |
          set +e
          PREVIOUS_TAG=$(gh release list \
              --limit 100 \
              --json tagName \
              --jq ".[] | select(.tagName | startswith(\"${PREFIX}\")) | .tagName" \
            | sort -V | tail -n 1)
          set -e

          if [[ -n "$PREVIOUS_TAG" ]]; then
            echo "Found previous release: $PREVIOUS_TAG"
            echo "PREVIOUS_TAG=$PREVIOUS_TAG" >> $GITHUB_ENV
            echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
          else
            echo "No previous tag found for prefix ${PREFIX}."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Delete previous release + tag if one exists
      - name: Delete previous release and tag
        if: env.PREVIOUS_TAG != ''
        run: |
          echo "Deleting previous release: $PREVIOUS_TAG"

          # Delete GitHub Release (if it exists)
          gh release delete "$PREVIOUS_TAG" -y || true

          # Delete local tag if present
          git tag -d "$PREVIOUS_TAG" || true

          # Delete remote tag
          git push origin ":refs/tags/$PREVIOUS_TAG" || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PREVIOUS_TAG: ${{ env.PREVIOUS_TAG }}

      # Create new release and attach the fat JAR from ./releases/
      - name: Create Release using GitHub CLI
        run: |
          gh release create "$RELEASE_TAG" ./releases/*.jar \
            --title "Release $RELEASE_TAG" \
            --notes "This jar file has been built by GitHub automatically." \
            --repo "$GITHUB_REPOSITORY"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
